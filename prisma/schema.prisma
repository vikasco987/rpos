generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum Role {
  USER
  ADMIN
  SELLER
}

enum FieldType {
  INPUT
  SELECT
  CHECKBOX
  RADIO
  FILE
}

//////////////////////////////////////////////////
// CATEGORY
//////////////////////////////////////////////////

model Category {
  id      String  @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  clerkId String?

  parentId String?    @db.ObjectId
  parent   Category?  @relation("Subcategories", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Category[] @relation("Subcategories")

  items     Item[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
model Item {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  description  String?
  price        Float?
  sellingPrice Float?
  gst          Float?
  unit         String?
  barcode      String?
  imageUrl     String?
  image        String?   // âœ… THIS MUST EXIST

  categoryId String?   @db.ObjectId
  category   Category? @relation(fields: [categoryId], references: [id])

  clerkId String
  userId  String @db.ObjectId

  isActive     Boolean  @default(true)

  user    User   @relation(fields: [userId], references: [id])

  purchases Purchase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// PARTY (CUSTOMER)
//////////////////////////////////////////////////

model Party {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String    @unique
  address   String?
  dob       DateTime?
  createdBy String
  user      User?     @relation(fields: [createdBy], references: [clerkId])
  bills     Bill[]
  createdAt DateTime  @default(now())
}

//////////////////////////////////////////////////
// BILL (POS CORE)
//////////////////////////////////////////////////

model Bill {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId      String  @db.ObjectId
  clerkUserId String?
  user        User    @relation(fields: [userId], references: [id])

  customerId String? @db.ObjectId
  customer   Party?  @relation(fields: [customerId], references: [id])

  billNumber String
  createdAt  DateTime @default(now())

  items Json

  subtotal        Float
  billDiscountPct Float?
  discountAmount  Float?
  taxableAmount   Float
  gstPercent      Float?
  cgst            Float
  sgst            Float
  total           Float

  paymentMode   String
  paymentStatus String
  upiTxnRef     String?

  isHeld    Boolean   @default(false)
  holdBy    String?
  holdAt    DateTime?
  resumedAt DateTime?

  companyName    String?
  companyAddress String?
  companyPhone   String?
  gstNumber      String?
  logoUrl        String?
  websiteUrl     String?

  history  BillHistory[]
  payments Payment[]
}

//////////////////////////////////////////////////
// BILL HISTORY
//////////////////////////////////////////////////

model BillHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  billId    String   @db.ObjectId
  bill      Bill     @relation(fields: [billId], references: [id])
  action    String
  snapshot  Json
  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// PAYMENT
//////////////////////////////////////////////////

model Payment {
  id     String   @id @default(auto()) @map("_id") @db.ObjectId
  billId String   @db.ObjectId
  bill   Bill     @relation(fields: [billId], references: [id])
  amount Float
  mode   String
  txnRef String?
  paidAt DateTime @default(now())
}

//////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////

model User {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  email   String @unique
  clerkId String @unique
  role    Role   @default(USER)

  items    Item[]
  bills    Bill[]
  parties  Party[]
  forms    Form[]
  profiles BusinessProfile[]
  uploads  Upload[]

  isDisabled Boolean @default(false)

  createdAt DateTime   @default(now())
  purchases Purchase[]

  activities ActivityLog[]
}

//////////////////////////////////////////////////
// FORM BUILDER
//////////////////////////////////////////////////

model Form {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  fields    Field[]
  userId    String
  user      User     @relation(fields: [userId], references: [clerkId])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Field {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  formId    String    @db.ObjectId
  form      Form      @relation(fields: [formId], references: [id])
  label     String
  type      FieldType
  required  Boolean   @default(false)
  options   String[]
  value     String?
  createdAt DateTime  @default(now())
}

//////////////////////////////////////////////////
// BUSINESS PROFILE
//////////////////////////////////////////////////

model BusinessProfile {
  id     String @id @default(auto()) @map("_id") @db.ObjectId

  userId String @unique
  user   User   @relation(fields: [userId], references: [clerkId])

  businessType       String?
  businessName       String?
  businessTagLine    String?

  contactPersonName  String?
  contactPersonPhone String?
  contactPersonEmail String?

  upi                String?

  profileImageUrl    String?
  logoUrl            String?
  signatureUrl       String?

  gstNumber          String?
  businessAddress    String?
  state              String?
  district           String?
  pinCode            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// UPLOAD
//////////////////////////////////////////////////

model Upload {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  imageUrl  String
  userId    String
  user      User     @relation(fields: [userId], references: [clerkId])
  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// Purchase
//////////////////////////////////////////////////

model Purchase {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String
  user   User   @relation(fields: [userId], references: [clerkId])

  itemId String @db.ObjectId
  item   Item   @relation(fields: [itemId], references: [id])

  quantity Float
  price    Float
  total    Float

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// ActivityLog
//////////////////////////////////////////////////

model ActivityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  action    String
  meta      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}


//////////////////////////////////////////////////
// BillManager
//////////////////////////////////////////////////

model BillManager {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId

  clerkUserId   String
  billNumber    String   @unique
  createdAt     DateTime @default(now())

  items         Json

  subtotal      Float
  tax           Float?
  total         Float

  paymentMode   String
  paymentStatus String
  upiTxnRef     String?
  isHeld        Boolean  @default(false)
  customerName  String?
  customerPhone String?

  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?
  deletedSnapshot Json?
}
